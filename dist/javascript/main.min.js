function stopPart(){Tone.Transport.stop(),console.log("stopPart() used")}function play_button_behaviour(t){"stopped"==t?(playButton.dataset.state="start",playButton.innerHTML='<span class="play"></span> Play'):"started"==t&&(playButton.dataset.state="stop",playButton.innerHTML='<span class="stop"></span> Stop',part.start())}function make_sound(){sequenceContainer.innerHTML="";for(var t=1;t<transmitanceHit.length;t++){var e=Math.round(1e3*transmitanceHit[t].transmitance)/1e3;duration+=e}totalTimeLabel.innerHTML=duration>1.99?duration+" <span>seconds</span>":duration+" <span>second</span>";for(var t=1;t<transmitanceHit.length;t++){var e=Math.round(1e3*transmitanceHit[t].transmitance*stepDurationFactor)/1e3,n=transmitanceHit[t].frequency+360*transpose,a={pitch_octave_note:new Tone.Frequency(n,"midi").toNote(),frequency_note:n,time:e},r=document.createElement("span");r.id="note-"+t,r.innerHTML=a.frequency_note,r.style.width=a.time/duration*100+"%",sequenceContainer.appendChild(r),notes.push(a)}}function play_sound(){synth=new Tone.MonoSynth({oscillator:{type:oscillatorTypeName,count:3,spread:30},envelope:{attack:.01,decay:.1,sustain:.5,release:.4,attackCurve:"exponential"}}).toMaster(),Array.prototype.slice.call(sequenceContainer.getElementsByTagName("span")).forEach(function(t){t.classList=""});var t=Tone.now(),e=t,n=1;part=new Tone.Part(function(t,a){var r="note-"+n,o=document.getElementById(r);o&&"stop"==playButton.dataset.state&&(o.classList="played",synth.triggerAttackRelease(a.frequency_note,t+a.time,t,.15),e+=a.time,n++),Tone.Transport.schedule(function(t){Tone.Draw.schedule(function(){play_button_behaviour("stopped")},t)},t)},notes),Tone.Transport.start()}function filter_JDX_data(t){moleculeIrData=new Array;for(var e=t.split("\n"),n=0;n<e.length-1;n++)if(void 0!==typeof e[n]&&""!==e[n]){var a=e[n].charAt(0);if(a%1==0){var r=e[n].split(" ");moleculeIrData.push({frequency:parseFloat(r[0]),value:parseFloat(r[1])})}else{var o=document.getElementById("data-comments"),s=document.getElementById("comment-source-file-modal"),i=document.createElement("p"),c=document.createElement("p");"#"==a?(n<9&&(i.innerHTML=e[n].substring(2)),c.innerHTML=e[n].substring(2)):(n<9&&(i.innerHTML=e[n].substring(2)),c.innerHTML=e[n]),o.append(i),s.appendChild(c)}}getTransmitanceHit(),chart_this(moleculeIrData),make_sound()}function getTransmitanceHit(){var t=Array.prototype.slice.call(moleculeIrData);transmitanceHit=[];for(var e=1;e<t.length;e++)if(t[e].value>t[e-1].value+transmitanceThreshold||t[e].value<t[e-1].value-transmitanceThreshold){var n={transmitance:t[e].value,frequency:Math.round(t[e].frequency)};transmitanceHit.push(n)}return transmitanceHit}function chart_this(t){var e=Array.prototype.slice.call(t),n=document.getElementById("canvas-wrapper"),a=document.getElementsByClassName("button")[0],r=document.defaultView.getComputedStyle(a,null).getPropertyValue("background-color");e.forEach(function(t){t.frequency=t.frequency,t.value=t.value});var o={top:20,right:30,bottom:30,left:40},s=n.offsetWidth-o.left-o.right,i=n.offsetHeight-o.top-o.bottom,c=d3.scaleLinear().rangeRound([s,0]),l=d3.scaleLinear().rangeRound([i,0]),d=d3.area().x(function(t){return c(t.frequency)}).y1(function(t){return l(t.value)}),u=d3.select("body #canvas-wrapper").insert("svg").attr("class","area-chart").datum(e).attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+(s+o.left+o.right)+" "+(i+o.top+o.bottom)).append("g").attr("transform","translate("+o.left+","+o.top+")");c.domain([e[0].frequency,e[e.length-1].frequency]),l.domain([0,d3.max(e,function(t){return t.value})]),d.y0(l(0)),u.append("linearGradient").attr("id","temperature-gradient").attr("gradientUnits","userSpaceOnUse").attr("x1",0).attr("y1",l(0)).attr("x2",s).attr("y2",l(1)).selectAll("stop").data([{offset:"0%",color:r},{offset:"50%",color:r},{offset:"100%",color:r}]).enter().append("stop").attr("offset",function(t){return t.offset}).attr("stop-color",function(t){return t.color}),u.append("path").data([e]).attr("class","area").attr("d",d),u.append("g").attr("class","grid").attr("transform","translate(0,"+i+")").call(function(){return d3.axisBottom(c).ticks(5)}().tickSize(-i).tickFormat("")),u.append("g").attr("transform","translate(0,"+i+")").call(d3.axisBottom(c)).attr("class","axisWhite").append("text").attr("transform","translate("+(s-60)+", -10)").attr("class","legend").text("Wavelength"),u.append("g").call(d3.axisLeft(l)).attr("class","axisWhite").append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.71em").attr("text-anchor","end").attr("class","legend").text("Transmitance")}var synth=null,frequencyRange={min:0,max:1200},part=new Tone.Part,notes=[],duration=0,oscillatorTypeName=null,oscillatorTypeDropdown=document.getElementById("oscillator-type-dropdown"),oscillatorsType=Array.prototype.slice.call(oscillatorTypeDropdown.getElementsByClassName("link")),oscillatorTypeLabel=document.getElementById("current-oscillator-type-output"),sequenceContainer=document.getElementById("resulted-sequence"),playButton=document.getElementById("playSound"),transposeSlider=document.getElementById("transpose"),transpose=transposeSlider.value,transposeOutput=document.getElementById("transposeOutput"),totalTimeLabel=document.getElementById("total-time");oscillatorsType.forEach(function(t){t.addEventListener("click",function(t){var e=this.getAttribute("data-oscillator");oscillatorTypeLabel.innerHTML=e},!1)}),oscillatorTypeName||(oscillatorTypeName="pwm",oscillatorTypeLabel.innerHTML=oscillatorTypeName),playButton.addEventListener("click",function(t){"start"==playButton.dataset.state?(Tone.Transport.stop(),play_sound(),play_button_behaviour("started")):"stop"==playButton.dataset.state&&(part.stop(0),Tone.Transport.stop(0),play_button_behaviour("stopped"))}),transposeSlider.addEventListener("input",function(){Tone.Transport.stop(),transpose=Number(transposeSlider.value),transposeOutput.innerHTML=transpose},!1),transposeSlider.addEventListener("mouseup",function(){make_sound()});var APP={Player:function(){function t(t,e){for(var n=0,a=t.length;n<a;n++)t[n](e)}function e(e){try{t(h.update,{time:e,delta:e-y})}catch(t){console.error(t.message||t,t.stack||"")}p.render(u,d),y=e}function n(e){t(h.keydown,e)}function a(e){t(h.keyup,e)}function r(e){t(h.mousedown,e)}function o(e){t(h.mouseup,e)}function s(e){t(h.mousemove,e)}function i(e){t(h.touchstart,e)}function c(e){t(h.touchend,e)}function l(e){t(h.touchmove,e)}var d,u,p,m=new THREE.ObjectLoader,h={},v=document.createElement("div");this.dom=v,this.width=500,this.height=500,this.load=function(e){p=new THREE.WebGLRenderer({antialias:!0}),p.setClearColor(0),p.setPixelRatio(window.devicePixelRatio);var n=e.project;n.gammaInput&&(p.gammaInput=!0),n.gammaOutput&&(p.gammaOutput=!0),n.shadows&&(p.shadowMap.enabled=!0),n.vr&&(p.vr.enabled=!0),v.appendChild(p.domElement),this.setScene(m.parse(e.scene)),this.setCamera(m.parse(e.camera)),h={init:[],start:[],stop:[],keydown:[],keyup:[],mousedown:[],mouseup:[],mousemove:[],touchstart:[],touchend:[],touchmove:[],update:[]};var a="player,renderer,scene,camera",r={};for(var o in h)a+=","+o,r[o]=o;var s=JSON.stringify(r).replace(/\"/g,"");for(var i in e.scripts){var c=u.getObjectByProperty("uuid",i,!0);if(void 0!==c)for(var l=e.scripts[i],y=0;y<l.length;y++){var f=l[y],g=new Function(a,f.source+"\nreturn "+s+";").bind(c)(this,p,u,d);for(var E in g)void 0!==g[E]&&(void 0!==h[E]?h[E].push(g[E].bind(c)):console.warn("APP.Player: Event type not supported (",E,")"))}else console.warn("APP.Player: Script without object.",i)}t(h.init,arguments)},this.setCamera=function(t){d=t,d.aspect=this.width/this.height,d.updateProjectionMatrix(),p.vr.enabled&&v.appendChild(WEBVR.createButton(p))},this.setScene=function(t){u=t},this.setSize=function(t,e){this.width=t,this.height=e,d&&(d.aspect=this.width/this.height,d.updateProjectionMatrix()),p&&p.setSize(t,e)};var y;this.play=function(){y=performance.now(),document.addEventListener("keydown",n),document.addEventListener("keyup",a),document.addEventListener("mousedown",r),document.addEventListener("mouseup",o),document.addEventListener("mousemove",s),document.addEventListener("touchstart",i),document.addEventListener("touchend",c),document.addEventListener("touchmove",l),t(h.start,arguments),p.animate(e)},this.stop=function(){document.removeEventListener("keydown",n),document.removeEventListener("keyup",a),document.removeEventListener("mousedown",r),document.removeEventListener("mouseup",o),document.removeEventListener("mousemove",s),document.removeEventListener("touchstart",i),document.removeEventListener("touchend",c),document.removeEventListener("touchmove",l),t(h.stop,arguments),p.animate(null)},this.dispose=function(){for(;v.children.length;)v.removeChild(v.firstChild);p.dispose(),d=void 0,u=void 0,p=void 0}}},dropdowns=Array.prototype.slice.call(document.getElementsByClassName("dropdown-button"));dropdowns.forEach(function(t){var e=Array.prototype.slice.call(document.getElementsByClassName("link"));t.addEventListener("click",function(t){t.preventDefault();var e=this.parentElement.id;document.getElementById(e).classList.toggle("active"),stopPart()},!1),e.forEach(function(t){t.addEventListener("click",function(t){t.preventDefault();var e=this.parentElement.parentElement.parentElement.parentElement.id;document.getElementById(e).classList.remove("active")})})});var canvasWrapper=document.getElementById("canvas-3d-wrapper"),canvasWidth=canvasWrapper.clientWidth,canvasHeight=canvasWrapper.clientHeight,loader=new THREE.FileLoader;loader.load("data/app.json",function(t){var e=new APP.Player;e.load(JSON.parse(t)),e.setSize(canvasWidth,canvasHeight),e.play(),canvasWrapper.appendChild(e.dom),window.addEventListener("resize",function(){e.setSize(window.innerWidth,window.innerHeight)})});var moleculeIrData=new Array,transmitanceHit=[],moleculeDropdown=document.getElementById("molecule-dropdown"),molecules_entry=Array.prototype.slice.call(moleculeDropdown.getElementsByClassName("link")),transmitanceThresholdSlider=document.getElementById("transmitanceThreshold"),transmitanceThreshold=transmitanceThresholdSlider.value/1e3,transmitanceThresholdOutput=document.getElementById("transmitanceThresholdOutput"),stepDurationFactorSlider=document.getElementById("stepDurationFactor"),stepDurationFactor=stepDurationFactorSlider.value/10,stepDurationFactorOutput=document.getElementById("stepDurationFactorOutput");molecules_entry.forEach(function(t){t.addEventListener("click",function(t){var e=this.getAttribute("data-file");document.getElementById("canvas-wrapper").innerHTML="",document.getElementById("data-comments").innerHTML="",get_JDX_data(e,filter_JDX_data),getTransmitanceHit(),make_sound()},!1)}),transmitanceThresholdSlider.addEventListener("input",function(){transmitanceThreshold=transmitanceThresholdSlider.value/1e3,transmitanceThresholdOutput.innerHTML=transmitanceThreshold},!1),transmitanceThresholdSlider.addEventListener("mouseup",function(){getTransmitanceHit(),make_sound()}),stepDurationFactorSlider.addEventListener("input",function(){stepDurationFactor=stepDurationFactorSlider.value/10,stepDurationFactorOutput.innerHTML=stepDurationFactor},!1),stepDurationFactorSlider.addEventListener("mouseup",function(){make_sound()}),get_JDX_data=function(t,e,n){var a=new XMLHttpRequest;a.overrideMimeType("text/plain"),a.onreadystatechange=function(){a.readyState===XMLHttpRequest.DONE&&(200===a.status?e&&e(a.responseText):n&&n(a))},a.open("GET",t,!0),a.send()},get_JDX_data("data/7732-18-5-IR.jdx",filter_JDX_data);var modalButtons=Array.prototype.slice.call(document.getElementsByClassName("modal-button"));modalButtons.forEach(function(t){t.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("data-toggle");console.log(e),document.getElementById(e).classList.toggle("active")},!1)});