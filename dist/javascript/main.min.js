function make_sound(){sequenceContainer.innerHTML="";for(var t=1;t<transmitanceHit.length;t++){var e=Math.round(1e3*transmitanceHit[t].transmitance)/1e3;duration+=e}for(var t=1;t<transmitanceHit.length;t++){var e=Math.round(1e3*transmitanceHit[t].transmitance)/1e3,a=transmitanceHit[t].frequency+180*transpose,n={pitch_octave_note:new Tone.Frequency(a,"midi").toNote(),frequency_note:a,time:e};console.log(n.frequency_note+" => "+a);var r=document.createElement("span");r.id="note-"+t,r.innerHTML=n.pitch_octave_note,r.style.width=n.time/duration*100+"%",sequenceContainer.appendChild(r),notes.push(n)}}function play_sound(){synth=new Tone.MonoSynth({oscillator:{type:oscillatorTypeName,count:3,spread:30},envelope:{attack:.01,decay:.1,sustain:.5,release:.4,attackCurve:"exponential"}}).toMaster(),Array.prototype.slice.call(sequenceContainer.getElementsByTagName("span")).forEach(function(t){t.classList=""});var t=Tone.now(),e=t,a=1;part=new Tone.Part(function(t,n){var r="note-"+a,o=document.getElementById(r);o&&(o.classList="played",synth.triggerAttackRelease(n.frequency_note,t+n.time,t,.15),e+=n.time,a++)},notes),Tone.Transport.start()}function filter_JDX_data(t){moleculeIrData=new Array;for(var e=t.split("\n"),a=0;a<e.length-1;a++)if(void 0!==typeof e[a]&&""!==e[a]){var n=e[a].charAt(0);if(n%1==0){var r=e[a].split(" ");moleculeIrData.push({frequency:parseFloat(r[0]),value:parseFloat(r[1])})}else{var o=document.getElementById("data-comments"),s=document.getElementById("comment-source-file-modal"),l=document.createElement("p"),i=document.createElement("p");"#"==n?(a<9&&(l.innerHTML=e[a].substring(2)),i.innerHTML=e[a].substring(2)):(a<9&&(l.innerHTML=e[a].substring(2)),i.innerHTML=e[a]),o.append(l),s.appendChild(i)}}getTransmitanceHit(),chart_this(moleculeIrData),make_sound()}function getTransmitanceHit(){var t=Array.prototype.slice.call(moleculeIrData);transmitanceHit=[];for(var e=1;e<t.length;e++)if(t[e].value>t[e-1].value+transmitanceThreshold||t[e].value<t[e-1].value-transmitanceThreshold){var a={transmitance:t[e].value,frequency:Math.round(t[e].frequency)};transmitanceHit.push(a)}return transmitanceHit}function chart_this(t){var e=Array.prototype.slice.call(t),a=document.getElementById("canvas-wrapper"),n=document.getElementsByClassName("button")[0],r=document.defaultView.getComputedStyle(n,null).getPropertyValue("background-color");e.forEach(function(t){t.frequency=t.frequency,t.value=t.value});var o={top:20,right:30,bottom:30,left:40},s=a.offsetWidth-o.left-o.right,l=a.offsetHeight-o.top-o.bottom,i=d3.scaleLinear().rangeRound([s,0]),c=d3.scaleLinear().rangeRound([l,0]),u=d3.area().x(function(t){return i(t.frequency)}).y1(function(t){return c(t.value)}),d=d3.select("body #canvas-wrapper").insert("svg").attr("class","area-chart").datum(e).attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+(s+o.left+o.right)+" "+(l+o.top+o.bottom)).append("g").attr("transform","translate("+o.left+","+o.top+")");i.domain([e[0].frequency,e[e.length-1].frequency]),c.domain([0,d3.max(e,function(t){return t.value})]),u.y0(c(0)),d.append("linearGradient").attr("id","temperature-gradient").attr("gradientUnits","userSpaceOnUse").attr("x1",0).attr("y1",c(0)).attr("x2",s).attr("y2",c(1)).selectAll("stop").data([{offset:"0%",color:r},{offset:"50%",color:r},{offset:"100%",color:r}]).enter().append("stop").attr("offset",function(t){return t.offset}).attr("stop-color",function(t){return t.color}),d.append("path").data([e]).attr("class","area").attr("d",u),d.append("g").attr("class","grid").attr("transform","translate(0,"+l+")").call(function(){return d3.axisBottom(i).ticks(5)}().tickSize(-l).tickFormat("")),d.append("g").attr("transform","translate(0,"+l+")").call(d3.axisBottom(i)).attr("class","axisWhite").append("text").attr("transform","translate("+(s-60)+", -10)").attr("class","legend").text("Wavelength"),d.append("g").call(d3.axisLeft(c)).attr("class","axisWhite").append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.71em").attr("text-anchor","end").attr("class","legend").text("Transmitance")}var synth=null,frequencyRange={min:0,max:1200},part=new Tone.Part,notes=[],duration=0,oscillatorTypeName=null,oscillatorTypeDropdown=document.getElementById("oscillator-type-dropdown"),oscillatorsType=Array.prototype.slice.call(oscillatorTypeDropdown.getElementsByClassName("link")),oscillatorTypeLabel=document.getElementById("current-oscillator-type-output"),sequenceContainer=document.getElementById("resulted-sequence"),playButton=document.getElementById("playSound"),transposeSlider=document.getElementById("transpose"),transpose=transposeSlider.value,transposeOutput=document.getElementById("transposeOutput");oscillatorsType.forEach(function(t){t.addEventListener("click",function(t){var e=this.getAttribute("data-oscillator");oscillatorTypeLabel.innerHTML=e},!1)}),oscillatorTypeName||(oscillatorTypeName="pwm",oscillatorTypeLabel.innerHTML=oscillatorTypeName),playButton.addEventListener("click",function(t){"started"==part.state?(Tone.Transport.stop(),playButton.classList="",playButton.innerHTML='<span class="play"></span> Play',part.stop(0),Tone.Transport.stop()):"started"!==part.state&&(Tone.Transport.stop(),play_sound(),playButton.classList="active",playButton.innerHTML='<span class="stop"></span> Stop',part.start())}),transposeSlider.addEventListener("input",function(){Tone.Transport.stop(),transpose=Number(transposeSlider.value),transposeOutput.innerHTML=transpose,make_sound()},!1);var dropdowns=Array.prototype.slice.call(document.getElementsByClassName("dropdown-button"));dropdowns.forEach(function(t){var e=Array.prototype.slice.call(document.getElementsByClassName("link"));t.addEventListener("click",function(t){t.preventDefault();var e=this.parentElement.id;document.getElementById(e).classList.toggle("active")},!1),e.forEach(function(t){t.addEventListener("click",function(t){t.preventDefault();var e=this.parentElement.parentElement.parentElement.parentElement.id;document.getElementById(e).classList.remove("active")})})});var moleculeIrData=new Array,transmitanceHit=[],moleculeDropdown=document.getElementById("molecule-dropdown"),molecules_entry=Array.prototype.slice.call(moleculeDropdown.getElementsByClassName("link")),transmitanceThresholdSlider=document.getElementById("transmitanceThreshold"),transmitanceThreshold=transmitanceThresholdSlider.value/1e3,transmitanceThresholdOutput=document.getElementById("transmitanceThresholdOutput"),stepDurationFactorSlider=document.getElementById("stepDurationFactor"),stepDurationFactor=stepDurationFactorSlider.value/10,stepDurationFactorOutput=document.getElementById("stepDurationFactorOutput");molecules_entry.forEach(function(t){t.addEventListener("click",function(t){var e=this.getAttribute("data-file");document.getElementById("canvas-wrapper").innerHTML="",document.getElementById("data-comments").innerHTML="",get_JDX_data(e,filter_JDX_data),getTransmitanceHit(),make_sound()},!1)}),transmitanceThresholdSlider.addEventListener("input",function(){transmitanceThreshold=transmitanceThresholdSlider.value/1e3,transmitanceThresholdOutput.innerHTML=transmitanceThreshold,getTransmitanceHit(),make_sound()},!1),stepDurationFactorSlider.addEventListener("input",function(){stepDurationFactor=stepDurationFactorSlider.value/10,stepDurationFactorOutput.innerHTML=stepDurationFactor,getTransmitanceHit(),make_sound()},!1),get_JDX_data=function(t,e,a){var n=new XMLHttpRequest;n.overrideMimeType("text/plain"),n.onreadystatechange=function(){n.readyState===XMLHttpRequest.DONE&&(200===n.status?e&&e(n.responseText):a&&a(n))},n.open("GET",t,!0),n.send()},get_JDX_data("data/7732-18-5-IR.jdx",filter_JDX_data);var modalButtons=Array.prototype.slice.call(document.getElementsByClassName("modal-button"));modalButtons.forEach(function(t){t.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("data-toggle");console.log(e),document.getElementById(e).classList.toggle("active")},!1)});